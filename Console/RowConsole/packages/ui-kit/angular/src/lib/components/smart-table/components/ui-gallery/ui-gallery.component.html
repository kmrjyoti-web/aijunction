@if (isOpen()) {
<div class="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-50" (click)="close.emit()">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 flex flex-col max-h-[90vh]"
    (click)="$event.stopPropagation()">
    <header class="flex items-center justify-between p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold">UI Gallery</h3>
      <div class="flex items-center gap-2">
        <button (click)="handleSuggestImprovements()" [disabled]="!activeCustomLayout()"
          class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-100 border border-transparent rounded-md hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed"
          title="Get AI suggestions for the active custom layout">
          <i class="pi pi-lightbulb"></i>
          <span>Suggest Improvements</span>
        </button>
        <button (click)="showCreateModal.set(true)"
          class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700">
          <i class="pi pi-sparkles"></i>
          <span>Create with AI</span>
        </button>
        <button (click)="close.emit()" class="p-2 rounded-full hover:bg-gray-100">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </header>

    <div class="p-6 overflow-y-auto">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- Default Layout Card -->
        <div class="border-2 rounded-lg cursor-pointer transition-all group relative"
          [class.border-indigo-500]="isLayoutActive(null)" [class.border-gray-300]="!isLayoutActive(null)"
          (click)="handleApply(null)">
          <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center rounded-t-md">
            <i class="pi pi-table text-4xl text-gray-400"></i>
          </div>
          <div class="p-3">
            <h4 class="font-semibold text-sm truncate">Default Layout</h4>
          </div>
          @if (isLayoutActive(null)) {
          <div
            class="absolute top-2 right-2 bg-indigo-600 text-white rounded-full h-6 w-6 flex items-center justify-center">
            <i class="pi pi-check text-xs"></i>
          </div>
          }
        </div>

        <!-- Custom Layout Cards -->
        @for (layout of layouts(); track layout.id) {
        <div class="border-2 rounded-lg cursor-pointer transition-all group relative"
          [class.border-indigo-500]="isLayoutActive(layout.id)" [class.border-gray-300]="!isLayoutActive(layout.id)"
          (click)="handleApply(layout.id)">
          <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center rounded-t-md p-2 overflow-hidden">
            <div class="transform scale-[0.3] origin-top-left" [innerHTML]="layout.htmlTemplate"></div>
          </div>
          <div class="p-3">
            <h4 class="font-semibold text-sm truncate">{{ layout.name }}</h4>
            <p class="text-xs text-gray-500 capitalize">{{ layout.targetView.replace('-', ' ') }}</p>
          </div>
          @if (isLayoutActive(layout.id)) {
          <div
            class="absolute top-2 right-2 bg-indigo-600 text-white rounded-full h-6 w-6 flex items-center justify-center">
            <i class="pi pi-check text-xs"></i>
          </div>
          }
          <button (click)="$event.stopPropagation(); deleteLayout.emit(layout.id)" title="Delete this layout"
            class="absolute top-1 right-1 p-1 rounded-full opacity-0 group-hover:opacity-100 bg-white/50 hover:bg-red-100 text-red-500 transition-opacity">
            <i class="pi pi-trash text-xs"></i>
          </button>
        </div>
        }
      </div>
    </div>
  </div>
</div>
}

@if (showCreateModal()) {
<app-create-layout-modal (close)="showCreateModal.set(false)"
  (generate)="generateLayout.emit($event); showCreateModal.set(false)" />
}

<!-- Suggestions Modal -->
@if ((isGeneratingSuggestions() || suggestions()) && isOpen()) {
<div class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[60]" (click)="suggestions.set('')">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4" (click)="$event.stopPropagation()">
    <header class="flex items-center justify-between p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold flex items-center gap-2"><i class="pi pi-lightbulb text-yellow-400"></i>AI
        Suggestions</h3>
      <button (click)="suggestions.set('')" class="p-2 rounded-full hover:bg-gray-100">
        <i class="pi pi-times"></i>
      </button>
    </header>
    <div class="p-6">
      @if (isGeneratingSuggestions()) {
      <div class="flex items-center gap-3">
        <i class="pi pi-spin pi-spinner text-2xl text-indigo-500"></i>
        <p>Analyzing your layout...</p>
      </div>
      } @else {
      <div class="prose max-w-none text-sm" [innerHTML]="suggestions()"></div>
      }
    </div>
  </div>
</div>
}