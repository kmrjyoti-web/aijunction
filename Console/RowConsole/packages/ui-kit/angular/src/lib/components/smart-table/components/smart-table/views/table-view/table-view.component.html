<div class="h-full flex flex-col border border-gray-300 bg-white w-full">

  <!-- Header Section (Scroll Sync) -->
  <div #headerContainer class="flex-shrink-0 overflow-hidden border-b border-gray-300 relative z-20"
    [style.padding-right.px]="scrollbarWidth()">
    <div class="flex min-w-full w-max" [class.bg-gray-100]="!styleConfig()?.enableTransparency"
      [style.background-color]="styleConfig()?.enableTransparency ? 'rgba(255, 255, 255, ' + ((styleConfig()?.transparencyOpacity ?? 90) / 100) + ')' : null">

      @for(col of columns(); track col.code; let i = $index; let isLast = $last) {
      <div [style.flex-basis]="col.frozen ? getColumnWidth(col) : '0px'" [style.min-width]="getColumnWidth(col)"
        [style.flex]="col.frozen ? '0 0 auto' : '1 1 0px'" [style.left]="col.frozen ? columnOffsets()[i] : null"
        class="p-2 font-semibold text-xs flex items-center relative transition-all duration-150 flex-shrink-0 group/header"
        [class.border-r]="!isLast" [class.border-r-transparent]="!showGridlines() && !col.frozen && !isLast"
        [class.border-r-gray-200]="(showGridlines() || col.frozen) && !isLast"
        [style.background-color]="styleConfig()?.headerBackgroundColor"
        [style.color]="styleConfig()?.headerBackgroundColor ? '#fff' : null"
        [class.text-gray-600]="!styleConfig()?.headerBackgroundColor" [class.sticky]="col.frozen"
        [class.left-0]="col.frozen" [class.z-30]="col.frozen"
        [class.bg-gray-100]="col.frozen && !styleConfig()?.headerBackgroundColor"
        [class.opacity-50]="draggedColumnIndex() === i" (dragover)="onDragOver($event)" (drop)="onDrop($event, i)"
        (dragend)="onDragEnd()">

        <div class="flex items-center gap-2 w-full max-w-full overflow-hidden"
          [class.justify-center]="col.align === 'center'" [class.justify-end]="col.align === 'right'"
          [class.justify-between]="col.align !== 'center' && col.align !== 'right'"
          [class.cursor-pointer]="col.sortable"
          [class.cursor-move]="col.columnType !== 'CHECKBOX' && col.columnType !== 'ACTION' && !col.frozen"
          [attr.draggable]="col.columnType !== 'CHECKBOX' && col.columnType !== 'ACTION' && !col.frozen"
          (dragstart)="onDragStart(i)" (click)="onSort(col.code)">

          <!-- Header Content -->
          @if (col.columnType === 'CHECKBOX' && enableMultiSelect()) {
          <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            [checked]="isAllSelectedOnPage()" (change)="toggleSelectAll()" (click)="$event.stopPropagation()"
            title="Select all on page">
          } @else if (col.columnType === 'ACTION') {
          <div class="relative mx-auto text-center flex items-center justify-center w-full">
            @if (headerMenuConfig()) {
            <button (click)="$event.stopPropagation(); isHeaderMenuOpen.set(!isHeaderMenuOpen())"
              class="p-1 rounded-full hover:bg-gray-200" [disabled]="selectedIds().size === 0"
              [class.opacity-50]="selectedIds().size === 0" title="Bulk actions">
              <i class="pi pi-ellipsis-v text-xs"></i>
            </button>
            @if (isHeaderMenuOpen()) {
            <app-header-menu [menuConfig]="headerMenuConfig()!" (actionClicked)="handleHeaderMenuAction($event)"
              (clickOutside)="isHeaderMenuOpen.set(false)"></app-header-menu>
            }
            } @else {
            <i class="pi pi-cog text-gray-400"></i>
            }
          </div>
          } @else {
          <div class="truncate select-none font-medium flex-1">
            {{ col.header || col.name }}
          </div>
          @if (sortColumn() === col.code) {
          <i class="pi ml-2 text-xs flex-shrink-0" [class.pi-sort-amount-up-alt]="sortDirection() === 'asc'"
            [class.pi-sort-amount-down]="sortDirection() === 'desc'"></i>
          }
          }

          <!-- Filter Icon -->
          @if(col.filterable) {
          <div class="relative flex-shrink-0 ml-1">
            <button (click)="openFilterMenu(col, $event)" class="p-1 rounded-full hover:bg-gray-200"
              [class.text-indigo-500]="activeFilters()?.[col.code]" title="Filter column">
              <i class="pi pi-filter text-[10px]"></i>
            </button>
            @if(openFilterMenuForColumn() === col) {
            <app-excel-filter [column]="col" [data]="data()" [activeFilter]="activeFilters()?.[col.code]"
              [showColorFilter]="showFilterByColor()" [colorResolver]="getColorResolverForColumn(col)"
              [position]="filterMenuPosition()" (apply)="handleApplyExcelFilter($event, col.code)"
              (close)="closeFilterMenu()" />
            }
          </div>
          }
        </div>

        <!-- Resize Handle -->
        @if (col.columnType !== 'CHECKBOX' && col.columnType !== 'ACTION') {
        <div class="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-indigo-400 z-50 transition-colors"
          (mousedown)="onResizeStart($event, i)" (click)="$event.stopPropagation()">
        </div>
        }
      </div>
      }
    </div>
  </div>

  <!-- Virtual Scroll Viewport -->
  <cdk-virtual-scroll-viewport [itemSize]="rowHeight()" minBufferPx="200" maxBufferPx="400"
    class="flex-grow w-full h-full min-w-full">
    <div *cdkVirtualFor="let row of dataSource(); trackBy: trackByPrimaryKey; let rowIndex = index"
      [class.bg-white]="!styleConfig()?.enableTransparency"
      [style.background-color]="selectedIds().has(row[primaryKey()]) || keyboardActiveRowIndex() === rowIndex ? '#eef2ff' : (styleConfig()?.enableTransparency ? 'rgba(255, 255, 255, ' + ((styleConfig()?.transparencyOpacity ?? 90) / 100) + ')' : null)"
      [style.box-shadow]="(selectedIds().has(row[primaryKey()]) || keyboardActiveRowIndex() === rowIndex) ? 'inset 0 2px 0 0 #818cf8, inset 0 -2px 0 0 #818cf8' : null"
      class="flex border-b border-gray-200 hover:bg-gray-50 transition-colors duration-150 min-w-full w-max group relative z-0"
      [id]="'table-item-' + row[primaryKey()]" (click)="onRowClick(row)"
      (contextmenu)="enableRowMenu() ? onRowContextMenu($event, row) : null">

      @let isRowActive = selectedIds().has(row[primaryKey()]) || keyboardActiveRowIndex() === rowIndex;

      @for(col of columns(); track col.code; let colIndex = $index; let isLast = $last) {
      <div [style.flex-basis]="col.frozen ? getColumnWidth(col) : '0px'" [style.min-width]="getColumnWidth(col)"
        [style.flex]="col.frozen ? '0 0 auto' : '1 1 0px'" [style.left]="col.frozen ? columnOffsets()[colIndex] : null"
        class="p-2 flex items-center overflow-hidden flex-shrink-0 text-sm whitespace-nowrap" [class.border-r]="!isLast"
        [class.border-r-transparent]="!showGridlines() && !col.frozen && !isLast"
        [class.border-r-gray-200]="(showGridlines() || col.frozen) && !isLast" [class.sticky]="col.frozen"
        [class.left-0]="col.frozen" [class.z-10]="col.frozen" [class.bg-white]="col.frozen && !isRowActive"
        [class.bg-indigo-50]="col.frozen && isRowActive" [class.group-hover:bg-gray-50]="col.frozen && !isRowActive"
        [class.justify-center]="col.align === 'center'" [class.justify-end]="col.align === 'right'"
        [class.font-bold]="isRowActive"
        [style.background-color]="isRowActive ? null : (isHexColor(getCellValidation(row, col).style?.bgcolor) ? getCellValidation(row, col).style?.bgcolor : null)"
        [style.color]="isHexColor(getCellValidation(row, col).style?.textcolor) ? getCellValidation(row, col).style?.textcolor : null">

        <!-- Cell Content Switch -->
        @switch (col.columnType) {
        @case('CHECKBOX') {
        @if (enableMultiSelect()) {
        <input type="checkbox"
          class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer z-10"
          [checked]="selectedIds().has(row[primaryKey()])" (change)="toggleRowSelection(row[primaryKey()])"
          (click)="$event.stopPropagation()">
        }
        }
        @case('ACTION') {
        <div class="flex justify-center items-center gap-1 w-full transition-opacity z-10"
          [style.opacity]="isRowActive ? '1' : '0'" [class.pointer-events-none]="!isRowActive"
          [class.pointer-events-auto]="isRowActive">
          @if(enableQuickActions() && rowActions(); as actions) {
          <div class="flex items-center gap-1">
            @for(action of actions; track action.action) {
            <button (click)="$event.stopPropagation(); rowAction.emit({action: action.action, row: row})"
              class="p-1 px-1.5 rounded-md transition-all flex items-center justify-center min-w-[28px] hover:bg-gray-200"
              [class.text-indigo-600]="isRowActive && !action.color"
              [class.text-gray-700]="!isRowActive && !action.color" [title]="action.label">
              <i [class]="action.icon + ' ' + (action.color || '')"></i>
            </button>
            }
          </div>
          }
        </div>
        }
        @case('DATE') {
        <span>{{ row[col.code] | date:'mediumDate' }}</span>
        }
        @case('MOBILE') {
        <div class="flex items-center justify-between w-full gap-2 group/mobile">
          <div class="truncate">
            @if (col.mask?.enabled) {
            {{ isUnmasked(row[primaryKey()], col.code) ? row[col.code] : maskString(row[col.code], col.mask!) }}
            @if (col.mask?.unmaskEnabled && row[col.code]) {
            <i class="pi text-xs ml-1 cursor-pointer text-gray-400 hover:text-gray-600"
              [class.pi-eye]="!isUnmasked(row[primaryKey()], col.code)"
              [class.pi-eye-slash]="isUnmasked(row[primaryKey()], col.code)"
              (click)="$event.stopPropagation(); toggleMask(row[primaryKey()], col.code)"></i>
            }
            } @else {
            {{ row[col.code] }}
            }
          </div>
          @if(row[col.code]) {
          <div class="flex gap-1 opacity-0 group-hover/mobile:opacity-100 transition-opacity">
            @if(col.mobileConfig?.showCall) { <a [href]="'tel:'+row[col.code]"
              class="text-green-600 hover:bg-green-100 p-1 rounded-full"><i class="pi pi-phone text-xs"></i></a> }
            @if(col.mobileConfig?.showWhatsapp) { <a [href]="'https://wa.me/'+row[col.code]" target="_blank"
              class="text-green-500 hover:bg-green-100 p-1 rounded-full"><i class="pi pi-whatsapp text-xs"></i></a> }
          </div>
          }
        </div>
        }
        @case('EMAIL') {
        <div class="flex items-center justify-between w-full gap-2 group/email">
          <div class="truncate">
            @if (col.mask?.enabled) {
            {{ isUnmasked(row[primaryKey()], col.code) ? row[col.code] : maskString(row[col.code], col.mask!) }}
            @if (col.mask?.unmaskEnabled && row[col.code]) {
            <i class="pi text-xs ml-1 cursor-pointer text-gray-400 hover:text-gray-600"
              [class.pi-eye]="!isUnmasked(row[primaryKey()], col.code)"
              [class.pi-eye-slash]="isUnmasked(row[primaryKey()], col.code)"
              (click)="$event.stopPropagation(); toggleMask(row[primaryKey()], col.code)"></i>
            }
            } @else {
            {{ row[col.code] }}
            }
          </div>
          @if(row[col.code] && col.emailConfig?.showAction) {
          <a [href]="'mailto:'+row[col.code]"
            class="opacity-0 group-hover/email:opacity-100 text-indigo-600 hover:bg-indigo-50 p-1 rounded-full"><i
              class="pi pi-send text-xs"></i></a>
          }
        </div>
        }
        @default {
        <!-- Standard Cell Template Logic -->
        @if (col.cellTemplate) {
        <div class="flex items-center gap-2 h-full w-full">
          <!-- 1. Handle Images (Hidden ONLY in Ultra Compact) -->
          @if (density() !== 'ultra-compact') {
          @for(item of col.cellTemplate; track item.code) {
          @if(item.columnType === 'IMAGE') {
          <div class="flex-shrink-0">
            @if(row[item.code]) { <img [src]="row[item.code]" class="h-8 w-8 rounded-full object-cover"
              [class.h-6]="density() === 'compact'" [class.w-6]="density() === 'compact'"> }
            @else { <div
              class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500"
              [class.h-6]="density() === 'compact'" [class.w-6]="density() === 'compact'">
              {{ (row['contact_person']?.[0] || 'A') }}</div> }
          </div>
          }
          }
          }

          <!-- 2. Handle Text Content (Stacked in Cozy/Comfortable, Inline in Compact/Ultra) -->
          <div class="min-w-0 flex-1" [class.flex]="density() === 'compact' || density() === 'ultra-compact'"
            [class.items-center]="density() === 'compact' || density() === 'ultra-compact'"
            [class.gap-2]="density() === 'compact' || density() === 'ultra-compact'"
            [class.flex-col]="density() === 'comfortable' || density() === 'cozy'"
            [class.justify-center]="density() === 'comfortable' || density() === 'cozy'">

            @for(item of col.cellTemplate; track item.code) {
            @if (item.columnType !== 'IMAGE') {
            @let val = row[item.code];
            @switch(item.tag || 'span') {
            @case('p') {
            <div class="truncate text-gray-900" [class.font-medium]="density() !== 'ultra-compact'"
              [class.font-bold]="item.bold || density() === 'ultra-compact'"
              [class.text-sm]="density() === 'comfortable' || density() === 'cozy'"
              [class.text-xs]="density() === 'compact' || density() === 'ultra-compact'">
              {{ val }}
            </div>
            }
            @case('small') {
            <div class="truncate text-gray-500" [class.text-xs]="true" [class.font-bold]="item.bold">
              {{ val }}
            </div>
            }
            @case('span') { <span [class.font-bold]="item.bold">{{ val }}</span> }
            }
            }
            }
          </div>
        </div>
        } @else {
        @if (col.mask?.enabled) {
        <div class="truncate">
          {{ isUnmasked(row[primaryKey()], col.code) ? row[col.code] : maskString(row[col.code], col.mask!) }}
          @if (col.mask?.unmaskEnabled && row[col.code]) {
          <i class="pi text-xs ml-1 cursor-pointer text-gray-400 hover:text-gray-600"
            [class.pi-eye]="!isUnmasked(row[primaryKey()], col.code)"
            [class.pi-eye-slash]="isUnmasked(row[primaryKey()], col.code)"
            (click)="$event.stopPropagation(); toggleMask(row[primaryKey()], col.code)"></i>
          }
        </div>
        } @else {
        <div class="truncate" [title]="row[col.code]">{{ row[col.code] }}</div>
        }
        }
        }
        }
      </div>
      }
      <!-- Row Context Menu (Triggered by Right Click) -->
      @if (enableRowMenu() && openMenuRow() === row) {
      <!-- Menu moved to root -->
      }
    </div>


  </cdk-virtual-scroll-viewport>

  <!-- Footer Section (Scroll Sync) -->
  @if(footerConfig()?.enabled && footerData(); as data) {
  <div #footerContainer class="flex-shrink-0 overflow-hidden border-t border-gray-300 relative z-20"
    [style.padding-right.px]="scrollbarWidth()">
    <div class="flex min-w-full w-max" [class.bg-gray-100]="!styleConfig()?.enableTransparency"
      [style.background-color]="styleConfig()?.enableTransparency ? 'rgba(255, 255, 255, ' + ((styleConfig()?.transparencyOpacity ?? 90) / 100) + ')' : null">
      @for(col of columns(); track col.code; let i = $index; let isLast = $last) {
      <div [style.flex-basis]="col.frozen ? getColumnWidth(col) : '0px'" [style.min-width]="getColumnWidth(col)"
        [style.flex]="col.frozen ? '0 0 auto' : '1 1 0px'" [style.left]="col.frozen ? columnOffsets()[i] : null"
        class="p-2 font-semibold text-xs flex items-center flex-shrink-0" [class.border-r]="!isLast"
        [class.border-r-gray-200]="!isLast" [class.sticky]="col.frozen" [class.left-0]="col.frozen"
        [class.z-30]="col.frozen" [class.bg-gray-100]="col.frozen" [class.justify-center]="col.align === 'center'"
        [class.justify-end]="col.align === 'right'">
        <span>{{ data[col.code] || '' }}</span>
      </div>
      }
    </div>
  </div>
  }
  @if (enableRowMenu() && openMenuRow()) {
  <app-row-menu [menuConfig]="rowMenuConfig()" [row]="openMenuRow()!" [position]="contextMenuPosition()"
    [showIcons]="enableRowMenuIcons()" [subMenuDirection]="'left'" (actionClicked)="handleRowMenuAction($event)"
    (clickOutside)="closeRowMenu()"></app-row-menu>
  }
</div>