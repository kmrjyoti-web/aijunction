<div class="grid" [class]="gridClasses()" [class.gap-6]="density() === 'comfortable'"
  [class.gap-4]="density() === 'cozy'" [class.gap-3]="density() === 'compact'">

  @for(item of data(); track item.organization_id; let i = $index) {
  @if(customTemplate(); as template) {
  <div [id]="'card-item-' + item.organization_id" class="border-2 rounded-lg transition-all duration-200 h-full"
    [class.cursor-pointer]="enableMultiSelect()" [class.border-transparent]="!selectedIds().has(item.organization_id)"
    [class.border-indigo-500]="selectedIds().has(item.organization_id)"
    [class.ring-2]="selectedIds().has(item.organization_id) || keyboardActiveRowIndex() === i"
    [class.ring-indigo-500]="selectedIds().has(item.organization_id) || keyboardActiveRowIndex() === i"
    (click)="onCardClick(item)" (contextmenu)="onCardContextMenu($event, item)">
    <app-dynamic-item [template]="template" [data]="item" />
  </div>
  } @else {
  <div [id]="'card-item-' + item.organization_id"
    class="border rounded-lg bg-white overflow-hidden transition-all duration-200 flex flex-col relative group"
    [class.border-gray-200]="!selectedIds().has(item.organization_id)"
    [class.hover:shadow-xl]="!selectedIds().has(item.organization_id)"
    [class.bg-slate-50]="selectedIds().has(item.organization_id)"
    [class.border-slate-500]="selectedIds().has(item.organization_id)" [class.ring-2]="keyboardActiveRowIndex() === i"
    [class.ring-offset-2]="keyboardActiveRowIndex() === i" [class.ring-slate-500]="keyboardActiveRowIndex() === i"
    (contextmenu)="onCardContextMenu($event, item)">
    <!-- Header -->
    <header class="flex justify-between items-start gap-4 border-b border-gray-200 bg-gray-50"
      [class.p-4]="density() !== 'compact'" [class.p-3]="density() === 'compact'">
      <div class="flex items-center gap-4 min-w-0">
        @if (item['avatar_url']) {
        <img [src]="item['avatar_url']" alt="Avatar" class="rounded-full object-cover flex-shrink-0"
          [class.h-10]="density() !== 'compact'" [class.w-10]="density() !== 'compact'"
          [class.h-9]="density() === 'compact'" [class.w-9]="density() === 'compact'">
        } @else {
        <div class="bg-gray-200 flex items-center justify-center rounded-full object-cover flex-shrink-0"
          [class.h-10]="density() !== 'compact'" [class.w-10]="density() !== 'compact'"
          [class.h-9]="density() === 'compact'" [class.w-9]="density() === 'compact'">
          <span class="font-semibold text-gray-500" [class.text-base]="density() !== 'compact'"
            [class.text-sm]="density() === 'compact'">{{ (item['contact_person']?.[0] || 'A') }}</span>
        </div>
        }
        <div class="min-w-0">
          <h3 class="font-bold text-gray-900 truncate" [class.text-base]="density() === 'comfortable'"
            [class.text-sm]="density() === 'cozy' || density() === 'compact'">{{ item['contact_person'] }}</h3>
          <p class="text-gray-600 truncate" [class]="densityClass()">
            {{ item['organization_name'] || 'N/A' }}
          </p>
        </div>
      </div>
      @if (rowMenuConfig()) {
      <div class="relative flex-shrink-0">
        <button (click)="toggleRowMenu($event, item.organization_id)"
          class="p-1 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-200" title="More actions">
          <i class="pi pi-ellipsis-v"></i>
        </button>
        @if (openMenuRowId() === item.organization_id) {
        <app-row-menu [menuConfig]="rowMenuConfig()!" [row]="item" [position]="contextMenuPosition()"
          (actionClicked)="handleRowMenuAction($event)" (clickOutside)="closeRowMenu()" />
        }
      </div>
      }
    </header>

    <!-- Body -->
    <div class="flex-grow cursor-pointer" [class.p-4]="density() !== 'compact'" [class.p-3]="density() === 'compact'"
      (click)="handleCardBodyClick(item)">
      <dl [class.space-y-3]="density() === 'comfortable'" [class.space-y-2]="density() !== 'comfortable'">
        @for (col of cardRowColumns(); track col.code) {
        @let validationState = getFieldValidationState(item, col);
        <div class="grid grid-cols-3 gap-2 p-1 -m-1 rounded-md transition-colors duration-150" [class]="densityClass()"
          [style.background-color]="!validationState.isValid ? validationState.style?.bgcolor : null"
          [title]="!validationState.isValid ? validationState.style?.tooltip : ''">
          <dt class="text-gray-500 font-medium col-span-1">{{ col.name }}</dt>
          <dd class="text-gray-800 truncate col-span-2">
            @if (col.mask?.enabled) {
            {{ maskString(item[col.code], col.mask) }}
            } @else {
            {{ item[col.code] || 'N/A' }}
            }
          </dd>
        </div>
        }
      </dl>
    </div>

    <!-- Footer -->
    @if (rowActions() && rowActions()!.length > 0) {
    <footer class="border-t border-gray-200 bg-gray-50 flex items-center justify-start"
      [class.p-2]="density() !== 'compact'" [class.p-1.5]="density() === 'compact'">
      <!-- Row Actions -->
      <div class="flex items-center gap-1">
        @if(rowActions(); as actions) {
        @for(action of actions; track action.action) {
        <button (click)="$event.stopPropagation(); rowAction.emit({ action: action.action, row: item })"
          class="p-1.5 rounded-full text-sm hover:bg-gray-200" [class]="action.color" [title]="action.label">
          <i [class]="action.icon"></i>
        </button>
        }
        }
      </div>
    </footer>
    }
  </div>
  }
  }
</div>